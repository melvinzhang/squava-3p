<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Squava</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            font-family: sans-serif;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(8, 40px);
            gap: 2px;
            margin-top: 20px;
        }
        .cell {
            width: 40px;
            height: 40px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-family: sans-serif;
            font-weight: bold;
        }
        .cell:hover { background: #eee; }
    </style>
</head>
<body>
    <h1>Squava: AI vs AI vs You</h1>
    <div style="margin-bottom: 10px;">
        <label for="playerSelect">Choose your player: </label>
        <select id="playerSelect">
            <option value="0">Player 1 (X)</option>
            <option value="1">Player 2 (O)</option>
            <option value="2" selected>Player 3 (Z)</option>
        </select>
        <button id="newGame" disabled>Start New Game</button>
    </div>
    <div id="status">Loading game engine...</div>
    <div id="board"></div>
    <pre id="output" style="display:none"></pre>

    <script>
        const worker = new Worker('worker.js');
        const status = document.getElementById('status');
        const boardDiv = document.getElementById('board');
        const output = document.getElementById('output');
        const newGameBtn = document.getElementById('newGame');
        const playerSelect = document.getElementById('playerSelect');

        let humanPlayerID = 2; // Default to P3

        worker.onmessage = (e) => {
            const { type, payload } = e.data;
            if (type === 'READY') {
                status.innerText = 'Ready. Choose your player and click "Start New Game".';
                newGameBtn.disabled = false;
            } else if (type === 'GAME_UPDATED') {
                renderBoard(payload.board);
                output.innerText = 'Hash: ' + payload.hash;
                
                if (!payload.board.terminal && payload.board.playerID !== humanPlayerID) {
                    const aiPlayer = payload.board.playerID + 1;
                    status.innerText = 'Player ' + aiPlayer + ' (AI) is thinking...';
                    setTimeout(() => {
                        worker.postMessage({ type: 'GET_AI_MOVE', payload: { iterations: 20000 } });
                    }, 600);
                }
            } else if (type === 'AI_MOVE_RESULT') {
                worker.postMessage({ type: 'APPLY_MOVE', payload: { idx: payload.move } });
            }
        };

        function getFatalBits(board) {
            let fatal = 0n;
            const players = [BigInt(board.p0), BigInt(board.p1), BigInt(board.p2)];
            for (let p = 0; p < 3; p++) {
                const isEliminated = !(board.activeMask & (1 << p));
                const isWinner = (board.terminal && board.winnerID === p);
                if (isEliminated || isWinner) {
                    const b = players[p];
                    const length = isWinner ? 4 : 3;
                    for (let i = 0; i < 64; i++) {
                        if (!(b & (1n << BigInt(i)))) continue;
                        const r = Math.floor(i / 8), c = i % 8;
                        const dirs = [[0, 1], [1, 0], [1, 1], [1, -1]];
                        for (const [dr, dc] of dirs) {
                            let count = 0, bits = 0n;
                            for (let s = 0; s < length; s++) {
                                const nr = r + dr * s, nc = c + dc * s;
                                if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                                    const nidx = nr * 8 + nc;
                                    if (b & (1n << BigInt(nidx))) { count++; bits |= (1n << BigInt(nidx)); }
                                }
                            }
                            if (count === length) fatal |= bits;
                        }
                    }
                }
            }
            return fatal;
        }

        function renderBoard(board) {
            boardDiv.innerHTML = '';
            const p0 = BigInt(board.p0);
            const p1 = BigInt(board.p1);
            const p2 = BigInt(board.p2);
            const fatal = getFatalBits(board);

            for (let i = 0; i < 64; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                const mask = 1n << BigInt(i);
                if ((p0 & mask) !== 0n) cell.innerText = 'X';
                else if ((p1 & mask) !== 0n) cell.innerText = 'O';
                else if ((p2 & mask) !== 0n) cell.innerText = 'Z';
                
                if ((fatal & mask) !== 0n) {
                    cell.style.backgroundColor = '#f8d7da';
                    cell.style.color = '#721c24';
                }

                cell.onclick = () => {
                    if (board.terminal || board.playerID !== humanPlayerID) return;
                    const m = 1n << BigInt(i);
                    if (((BigInt(board.p0) | BigInt(board.p1) | BigInt(board.p2)) & m) !== 0n) return;
                    
                    // Check forced moves if any
                    const fMask = BigInt(board.forcedMoves || "0");
                    if (fMask !== 0n && (fMask & m) === 0n) {
                        return; // Not a valid forced move
                    }

                    worker.postMessage({ type: 'APPLY_MOVE', payload: { idx: i } });
                };
                boardDiv.appendChild(cell);
            }
            if (board.terminal) {
                status.innerText = 'Game Over. Winner: ' + (board.winnerID === -1 ? 'Draw' : 'Player ' + (board.winnerID + 1));
            } else {
                let active = [];
                for(let i=0; i<3; i++) {
                    if (board.activeMask & (1 << i)) active.push(i+1);
                }
                let forcedText = "";
                if (board.forcedMoves && board.forcedMoves !== "0") {
                    forcedText = " | YOU MUST BLOCK!";
                }
                
                if (board.playerID === humanPlayerID) {
                    status.innerText = 'YOUR TURN (Player ' + (humanPlayerID + 1) + ') | Active: ' + active.join(', ') + forcedText;
                } else {
                    status.innerText = 'Player ' + (board.playerID + 1) + ' (AI) is thinking...' + forcedText;
                }
            }
            highlightForced(board.forcedMoves, board.playerID === humanPlayerID);
        }

        function highlightForced(forcedMaskStr, isUserTurn) {
            const cells = document.querySelectorAll('.cell');
            const mask = BigInt(forcedMaskStr || "0");
            cells.forEach((cell, i) => {
                cell.style.backgroundColor = '';
                if (mask !== 0n) {
                    if ((mask & (1n << BigInt(i))) !== 0n) {
                        cell.style.backgroundColor = isUserTurn ? '#fff3cd' : '#eee'; 
                        cell.style.borderColor = isUserTurn ? '#ffc107' : '#ccc';
                    } else {
                        cell.style.opacity = '0.5';
                    }
                } else {
                    cell.style.opacity = '1';
                    cell.style.borderColor = '#ccc';
                }
            });
        }

        newGameBtn.onclick = () => {
            humanPlayerID = parseInt(playerSelect.value);
            worker.postMessage({ type: 'NEW_GAME' });
        };
    </script>
</body>
</html>